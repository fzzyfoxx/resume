# Paths are relative to that temporary context.
FROM python:3.10-slim-buster

WORKDIR /app

# Install system dependencies for cairosvg
# Use archived repositories for Debian Buster
RUN sed -i 's|http://deb.debian.org/debian|http://archive.debian.org/debian|g' /etc/apt/sources.list && \
    sed -i 's|http://security.debian.org/debian-security|http://archive.debian.org/debian-security|g' /etc/apt/sources.list && \
    apt-get update && apt-get install -y \
    libcairo2 \
    libcairo2-dev \
    libpango1.0-0 \
    libpango1.0-dev \
    libjpeg-dev \
    libpng-dev \
    libgdk-pixbuf2.0-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy the service's requirements.txt from the temporary build context
COPY requirements.txt .

# Copy the pre-built wheels from the temporary build context
# (which were copied there by the Python script)
COPY packages /tmp/wheels/

# Install dependencies, including the local wheel
RUN pip install --no-cache-dir \
    --find-links=/tmp/wheels/ \
    geodoc_config \
    geodoc_loader \
    -r requirements.txt

# Copy the service's own code
COPY spatial-data-downloader.py .

# Clean up
RUN rm -rf /tmp/wheels/

# Define how your service runs
CMD ["python", "spatial-data-downloader.py"]